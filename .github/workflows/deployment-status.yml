name: Deployment Status Workflow

on:
  push:
    branches:
      - main

permissions:
  contents: write
  issues: write

jobs:
  pre-deployment:
    name: pre-deployment
    runs-on: ubuntu-latest
    outputs:
      issue-number: ${{ steps.create-issue.outputs.issue-number }}
      previous-commit: ${{ steps.get-commit-info.outputs.previous-commit }}
      current-commit: ${{ steps.get-commit-info.outputs.current-commit }}
      package-version: ${{ steps.get-commit-info.outputs.package-version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run lint
        run: npm run lint
      
      - name: Run tests
        run: npm test
      
      - name: Get commit information
        id: get-commit-info
        run: |
          CURRENT_COMMIT="${{ github.sha }}"
          PREVIOUS_COMMIT=$(git rev-parse HEAD~1)
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          
          echo "current-commit=${CURRENT_COMMIT}" >> $GITHUB_OUTPUT
          echo "previous-commit=${PREVIOUS_COMMIT}" >> $GITHUB_OUTPUT
          echo "package-version=${PACKAGE_VERSION}" >> $GITHUB_OUTPUT
          
          echo "Current Commit: ${CURRENT_COMMIT}"
          echo "Previous Commit: ${PREVIOUS_COMMIT}"
          echo "Package Version: ${PACKAGE_VERSION}"
      
      - name: Create deployment tracking issue
        id: create-issue
        uses: actions/github-script@v7
        with:
          script: |
            const commitSha = context.sha.substring(0, 7);
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Deployment Tracking - ${commitSha}`,
              body: `## Deployment Tracking Issue
              
              **Commit SHA:** ${context.sha}
              **Triggered by:** ${context.actor}
              **Workflow:** ${context.workflow}
              **Run ID:** ${context.runId}
              
              This issue tracks the deployment process for commit ${commitSha}.`,
              labels: ['deployment', 'in-progress']
            });
            
            console.log(`Created deployment tracking issue #${issue.data.number}`);
            core.setOutput('issue-number', issue.data.number);
            return issue.data.number;
      
      - name: Post pre-deployment comment
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.create-issue.outputs.issue-number }};
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `âœ… Pre-deployment checks completed
              
              - Linting: Passed
              - Tests: Passed
              - Dependencies: Verified`
            });

  rollback-preparation:
    name: rollback-preparation
    runs-on: ubuntu-latest
    needs: pre-deployment
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Create rollback artifacts
        id: create-rollback
        run: |
          mkdir -p rollback-artifacts
          
          # Create rollback script
          cat > rollback-artifacts/rollback.sh << 'ROLLBACK_SCRIPT'
          #!/bin/bash
          set -e
          
          echo "=========================================="
          echo "Starting Rollback Process"
          echo "=========================================="
          
          # Error handling function
          handle_error() {
            echo "ERROR: Rollback failed at step: $1"
            exit 1
          }
          
          # Check if git is available
          if ! command -v git &> /dev/null; then
            handle_error "Git is not installed"
          fi
          
          # Get previous commit SHA from environment or parameter
          PREVIOUS_COMMIT="${PREVIOUS_COMMIT:-$1}"
          
          if [ -z "$PREVIOUS_COMMIT" ]; then
            echo "ERROR: Previous commit SHA not provided"
            echo "Usage: ./rollback.sh <commit-sha>"
            exit 1
          fi
          
          echo "Target commit: $PREVIOUS_COMMIT"
          
          # Verify commit exists
          if ! git rev-parse --verify "$PREVIOUS_COMMIT" &> /dev/null; then
            handle_error "Commit $PREVIOUS_COMMIT not found"
          fi
          
          # Backup current state
          echo "Creating backup of current state..."
          BACKUP_BRANCH="backup-$(date +%Y%m%d-%H%M%S)"
          git branch "$BACKUP_BRANCH" || handle_error "Failed to create backup branch"
          echo "Backup branch created: $BACKUP_BRANCH"
          
          # Perform rollback
          echo "Rolling back to commit: $PREVIOUS_COMMIT"
          git checkout "$PREVIOUS_COMMIT" || handle_error "Failed to checkout previous commit"
          
          # Restore configuration files
          echo "Restoring configuration files..."
          if [ -f "./rollback-artifacts/backups/package.json" ]; then
            cp ./rollback-artifacts/backups/package.json ./package.json
          fi
          if [ -f "./rollback-artifacts/backups/package-lock.json" ]; then
            cp ./rollback-artifacts/backups/package-lock.json ./package-lock.json
          fi
          
          # Reinstall dependencies
          echo "Reinstalling dependencies..."
          if command -v npm &> /dev/null; then
            npm ci || handle_error "Failed to install dependencies"
          fi
          
          echo "=========================================="
          echo "Rollback completed successfully"
          echo "=========================================="
          ROLLBACK_SCRIPT
          
          chmod +x rollback-artifacts/rollback.sh
          
          # Backup configuration files
          mkdir -p rollback-artifacts/backups
          cp package.json rollback-artifacts/backups/package.json
          cp package-lock.json rollback-artifacts/backups/package-lock.json
          
          # Create environment template
          cat > rollback-artifacts/backups/.env.template << 'ENV_TEMPLATE'
          # Environment Configuration Template
          NODE_ENV=production
          PORT=3000
          # Add other environment variables as needed
          ENV_TEMPLATE
          
          # Create dependency verification script
          cat > rollback-artifacts/verify-dependencies.sh << 'VERIFY_SCRIPT'
          #!/bin/bash
          set -e
          
          echo "Verifying dependencies compatibility..."
          
          if [ ! -f "package.json" ]; then
            echo "ERROR: package.json not found"
            exit 1
          fi
          
          if [ ! -f "package-lock.json" ]; then
            echo "ERROR: package-lock.json not found"
            exit 1
          fi
          
          # Check Node.js version
          REQUIRED_NODE_VERSION=$(node -p "require('./package.json').engines.node" 2>/dev/null || echo ">=18.0.0")
          CURRENT_NODE_VERSION=$(node --version)
          echo "Required Node.js: $REQUIRED_NODE_VERSION"
          echo "Current Node.js: $CURRENT_NODE_VERSION"
          
          # Verify npm can read package.json
          npm ls --depth=0 || echo "Warning: Some dependencies may have issues"
          
          echo "Dependency verification completed"
          VERIFY_SCRIPT
          
          chmod +x rollback-artifacts/verify-dependencies.sh
          
          # Create rollback documentation
          cat > rollback-artifacts/ROLLBACK_GUIDE.md << 'ROLLBACK_GUIDE'
          # Rollback Guide
          
          ## Quick Rollback Steps
          
          1. **Extract the rollback package**
             ```bash
             tar -xzf rollback-package.tar.gz
             cd rollback-artifacts
             ```
          
          2. **Review the rollback plan**
             - Check ROLLBACK_PLAN.txt for commit details
             - Verify checksums in CHECKSUMS.txt
          
          3. **Execute the rollback script**
             ```bash
             ./rollback.sh <previous-commit-sha>
             ```
          
          4. **Verify the rollback**
             ```bash
             ./verify-dependencies.sh
             npm test
             ```
          
          5. **Restore environment configuration**
             ```bash
             cp backups/.env.template .env
             # Edit .env with appropriate values
             ```
          
          ## Manual Rollback Steps
          
          If the automated script fails, follow these manual steps:
          
          1. Create a backup branch
             ```bash
             git branch backup-$(date +%Y%m%d-%H%M%S)
             ```
          
          2. Checkout previous commit
             ```bash
             git checkout <previous-commit-sha>
             ```
          
          3. Restore configuration files
             ```bash
             cp rollback-artifacts/backups/package.json ./
             cp rollback-artifacts/backups/package-lock.json ./
             ```
          
          4. Reinstall dependencies
             ```bash
             npm ci
             ```
          
          5. Run tests to verify
             ```bash
             npm test
             npm run lint
             ```
          
          ## Troubleshooting
          
          - **Git issues**: Ensure you have proper git permissions
          - **Dependency conflicts**: Clear node_modules and reinstall
          - **Environment issues**: Check Node.js version matches requirements
          
          ## Support
          
          For assistance, refer to the deployment tracking issue or contact the development team.
          ROLLBACK_GUIDE
          
          # Create rollback plan document
          cat > rollback-artifacts/ROLLBACK_PLAN.txt << EOF
          Rollback Plan
          =============
          
          Previous Commit: ${{ needs.pre-deployment.outputs.previous-commit }}
          Current Commit: ${{ needs.pre-deployment.outputs.current-commit }}
          Package Version: ${{ needs.pre-deployment.outputs.package-version }}
          Created: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          Rollback Components:
          - Executable rollback script with error handling
          - Configuration backups (package.json, package-lock.json)
          - Environment template
          - Dependency verification script
          - Comprehensive rollback documentation
          
          Artifact Name: rollback-package-${{ needs.pre-deployment.outputs.current-commit }}
          EOF
          
          # Create compressed package
          tar -czf rollback-package.tar.gz rollback-artifacts/
          
          # Generate checksums
          SHA256_CHECKSUM=$(sha256sum rollback-package.tar.gz | awk '{print $1}')
          echo "$SHA256_CHECKSUM  rollback-package.tar.gz" > CHECKSUMS.txt
          cp CHECKSUMS.txt rollback-artifacts/CHECKSUMS.txt
          
          echo "checksum=${SHA256_CHECKSUM}" >> $GITHUB_OUTPUT
          echo "artifact-name=rollback-package-${{ needs.pre-deployment.outputs.current-commit }}" >> $GITHUB_OUTPUT
          echo "Rollback artifacts created successfully"
          echo "SHA256: ${SHA256_CHECKSUM}"
      
      - name: Upload rollback artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rollback-package-${{ needs.pre-deployment.outputs.current-commit }}
          path: |
            rollback-artifacts/
            rollback-package.tar.gz
            CHECKSUMS.txt
          retention-days: 30
      
      - name: Post rollback plan comment
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ needs.pre-deployment.outputs.issue-number }};
            const previousCommit = '${{ needs.pre-deployment.outputs.previous-commit }}';
            const currentCommit = '${{ needs.pre-deployment.outputs.current-commit }}';
            const packageVersion = '${{ needs.pre-deployment.outputs.package-version }}';
            const artifactName = '${{ steps.create-rollback.outputs.artifact-name }}';
            const checksum = '${{ steps.create-rollback.outputs.checksum }}';
            
            const comment = `## ðŸ”„ Rollback Plan Ready
            
            **Commit Information:**
            - Previous Commit: ${previousCommit}
            - Current Commit: ${currentCommit}
            - Package Version: ${packageVersion}
            
            **Rollback Artifacts:**
            - Artifact: ${artifactName}
            - SHA256: ${checksum}
            
            **Rollback Components Created:**
            âœ… Executable rollback script with error handling
            âœ… Configuration backups (package.json, package-lock.json)
            âœ… Environment configuration template
            âœ… Dependency verification script
            âœ… Comprehensive rollback documentation
            âœ… Compressed rollback package with checksums
            
            **Quick Rollback Command:**
            \`\`\`bash
            # Download artifact from Actions run
            # Extract and execute:
            tar -xzf rollback-package.tar.gz
            cd rollback-artifacts
            ./rollback.sh ${previousCommit}
            \`\`\`
            
            **Verification Status:**
            - Rollback script created: true
            - Configuration backup: true
            - Artifact uploaded: true
            - Checksum verified: true
            
            **Artifact Details:**
            - Retention: 30 days
            - Location: GitHub Actions artifacts for run #${context.runId}
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: comment
            });

  post-deployment:
    name: post-deployment
    runs-on: ubuntu-latest
    needs: [pre-deployment, rollback-preparation]
    
    steps:
      - name: Remove in-progress label and add completed label
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ needs.pre-deployment.outputs.issue-number }};
            
            // Remove in-progress label
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'in-progress'
              });
              console.log('Removed in-progress label');
            } catch (error) {
              console.log('Note: in-progress label may not exist');
            }
            
            // Add completed label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['completed']
            });
            console.log('Added completed label');
      
      - name: Post final deployment comment
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ needs.pre-deployment.outputs.issue-number }};
            const currentCommit = '${{ needs.pre-deployment.outputs.current-commit }}';
            const runId = context.runId;
            
            const comment = `## âœ… Deployment Completed Successfully
            
            **Deployment Details:**
            - Commit: ${currentCommit}
            - Workflow Run: #${runId}
            - Completed: ${new Date().toISOString()}
            
            **Rollback Information:**
            - Rollback artifacts are available in the Actions artifacts
            - Artifacts retention: 30 days
            - Refer to the rollback plan comment above for instructions
            
            **Next Steps:**
            - Monitor application health
            - Verify deployment in production
            - Keep rollback artifacts available for emergency recovery
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: comment
            });
      
      - name: Close deployment tracking issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ needs.pre-deployment.outputs.issue-number }};
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed',
              state_reason: 'completed'
            });
            
            console.log(`Closed deployment tracking issue #${issueNumber}`);
